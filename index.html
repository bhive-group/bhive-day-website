<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BHIVE Day 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
  <div class="max-w-6xl mx-auto p-4">
    <header class="bg-white shadow rounded p-4 mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-bold">BHIVE Day 2025</h1>
      <div id="top-scorecard" class="ml-4"></div>
    </header>

    <main id="app" aria-live="polite">
      <div id="loading" class="text-center py-12 text-gray-500">Loading…</div>
    </main>
  </div>

  <script>
  (function(){
    const app = document.getElementById('app');
    const loading = document.getElementById('loading');

    function hexToRgb(hex){
      const h = (hex||'#000').replace('#','');
      const full = h.length===3? h.split('').map(s=>s+s).join(''): h;
      const bigint = parseInt(full,16);
      return [(bigint>>16)&255, (bigint>>8)&255, bigint&255];
    }
    function luminance(r,g,b){
      const a=[r,g,b].map(v=>{
        v/=255;
        return v<=0.03928? v/12.92: Math.pow((v+0.055)/1.055,2.4);
      });
      return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2];
    }
    function contrastRatio(hexA, hexB){
      const a=hexToRgb(hexA);
      const b=hexToRgb(hexB);
      const L1 = luminance(a[0],a[1],a[2]);
      const L2 = luminance(b[0],b[1],b[2]);
      const lighter = Math.max(L1,L2);
      const darker = Math.min(L1,L2);
      return (lighter+0.05)/(darker+0.05);
    }
    function blend(hex, amount){
      const [r,g,b]=hexToRgb(hex);
      const t = amount;
      const br = Math.round(r*(1-t));
      const bg = Math.round(g*(1-t));
      const bb = Math.round(b*(1-t));
      return '#'+[br,bg,bb].map(v=>v.toString(16).padStart(2,'0')).join('');
    }
    function ordinal(pos){
      if(pos%100>=11 && pos%100<=13) return pos+'th';
      const m = pos%10;
      if(m===1) return pos+'st';
      if(m===2) return pos+'nd';
      if(m===3) return pos+'rd';
      return pos+'th';
    }

    function buildHeaderTop(team){
      const wrap = document.createElement('div');
      wrap.className = 'bg-gray-50 inline-flex items-center space-x-3 px-3 py-2 rounded';
      const name = document.createElement('div');
      name.className = 'text-sm font-semibold';
      name.style.color = team.color || '#111827';
      name.textContent = team.name;
      const meta = document.createElement('div');
      meta.className = 'text-xs text-gray-500';
      meta.textContent = `#${team.rank} · ${team.total} pts`;
      wrap.appendChild(name);
      wrap.appendChild(meta);
      return wrap;
    }

    function applyTeamTotals(teams, rankColors){
      const section = document.createElement('section');
      section.className = 'mb-8';
      const h = document.createElement('h2');
      h.className = 'text-lg font-semibold mb-3';
      h.textContent = 'Team Totals';
      section.appendChild(h);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';

      teams.forEach(team=>{
        const card = document.createElement('article');
        card.className = 'relative bg-white shadow-sm rounded p-4 flex items-start';
        card.style.borderLeft = '4px solid ' + (team.color || '#000');

        const info = document.createElement('div');
        info.className = 'flex-1';

        const name = document.createElement('div');
        name.className = 'text-xl font-semibold';
        name.style.color = team.color || '#111827';
        name.textContent = team.name;
        info.appendChild(name);

        const score = document.createElement('div');
        score.className = 'text-sm text-gray-500 mt-1';
        score.textContent = String(team.total) + ' pts';
        info.appendChild(score);

        card.appendChild(info);

        // rank pill on right
        const rankColor = rankColors[String(team.rank)] || '#111827';
        let pillBg = rankColor;
        if(contrastRatio(pillBg, '#ffffff') < 4.5) pillBg = blend(pillBg, 0.35);

        const pill = document.createElement('div');
        pill.className = 'ml-3 flex-shrink-0 flex items-center justify-center text-white font-bold';
        pill.style.backgroundColor = pillBg;
        pill.style.color = '#ffffff';
        pill.style.minWidth = '40px';
        pill.style.height = '40px';
        pill.style.borderRadius = '9999px';
        pill.style.fontSize = '1.25rem';
        pill.textContent = team.rank;
        pill.setAttribute('aria-label','Rank '+team.rank);

        card.appendChild(pill);

        grid.appendChild(card);
      });

      section.appendChild(grid);
      return section;
    }

    function applyPastEvents(pastEvents, teamsByName){
      const section = document.createElement('section');
      section.className = 'mb-8';
      const h = document.createElement('h2');
      h.className = 'text-lg font-semibold mb-3';
      h.textContent = 'Past Events';
      section.appendChild(h);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

      (pastEvents || []).forEach(ev=>{
        const card = document.createElement('article');
        card.className = 'bg-white shadow-sm rounded p-4';
        const title = document.createElement('h3');
        title.className = 'font-semibold mb-2';
        title.textContent = ev.name;
        card.appendChild(title);

        const list = document.createElement('ol');
        list.className = 'list-decimal list-inside space-y-1';

        (ev.placements || []).sort((a,b)=>a.pos-b.pos).forEach(place=>{
          const li = document.createElement('li');
          li.className = 'flex justify-between';
          const teamSpan = document.createElement('span');
          const team = teamsByName[place.team];
          teamSpan.textContent = place.team;
          teamSpan.style.color = team?.color || '#111827';
          const pts = document.createElement('span');
          pts.className = 'text-sm text-gray-500';
          pts.textContent = place.points + ' pts';
          li.appendChild(teamSpan);
          li.appendChild(pts);
          list.appendChild(li);
        });

        card.appendChild(list);
        grid.appendChild(card);
      });

      section.appendChild(grid);
      return section;
    }

    function applyUpcoming(upcoming){
      const section = document.createElement('section');
      section.className = 'mb-12';
      const h = document.createElement('h2');
      h.className = 'text-lg font-semibold mb-3';
      h.textContent = 'Upcoming Events';
      section.appendChild(h);

      const tableWrap = document.createElement('div');
      tableWrap.className = 'bg-white shadow-sm rounded overflow-auto';

      const table = document.createElement('table');
      table.className = 'min-w-full table-auto';

      const thead = document.createElement('thead');
      thead.className = 'bg-gray-100';
      thead.innerHTML = '<tr><th class="text-left p-3">Event</th><th class="p-3">1st</th><th class="p-3">2nd</th><th class="p-3">3rd</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      (upcoming || []).forEach(ev=>{
        const tr = document.createElement('tr');
        tr.className = 'border-t';
        const nameTd = document.createElement('td');
        nameTd.className = 'p-3';
        nameTd.textContent = ev.name;
        tr.appendChild(nameTd);

        const positions = (ev.positions || []).sort((a,b)=>a.pos-b.pos);
        for(let i=0;i<3;i++){
          const pos = positions[i] || {pos: i+1, points: 0};
          const td = document.createElement('td');
          td.className = 'p-3 text-center';
          const label = ordinal(pos.pos);
          td.textContent = `${label} — ${pos.points} pts`;
          if(i===0) td.classList.add('font-semibold');
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      tableWrap.appendChild(table);
      section.appendChild(tableWrap);
      return section;
    }

    function showError(message){
      app.innerHTML = '';
      const err = document.createElement('div');
      err.className = 'bg-red-50 border border-red-200 text-red-800 p-4 rounded';
      err.textContent = message;
      app.appendChild(err);
    }

    fetch('./data.json', {cache: 'no-store'}).then(r=>{
      if(!r.ok) throw new Error('Failed to load data.json: '+r.status);
      return r.json();
    }).then(data=>{
      loading?.remove();
      app.innerHTML = '';

      const teamsSource = data.teams || [];
      const pastEvents = data.pastEvents || [];
      const rankColors = data.rankColors || {};

      const totals = {};
      (pastEvents || []).forEach(ev=>{
        (ev.placements || []).forEach(p=>{
          totals[p.team] = (totals[p.team] || 0) + (p.points || 0);
        });
      });

      teamsSource.forEach(t=>{
        if(!(t.name in totals)) totals[t.name] = t.total || 0;
      });

      const teams = teamsSource.map(t=>({
        name: t.name,
        color: t.color,
        total: totals[t.name] || 0
      }));

      teams.sort((a,b)=>b.total - a.total);
      teams.forEach((t,i)=> t.rank = i+1);

      const teamsByName = {};
      teams.forEach(t=>teamsByName[t.name] = t);

      // header top team
      const top = teams[0] || {name:'—', color:'#111827', rank:1, total:0};
      const headerCard = buildHeaderTop(top);
      const headerSlot = document.getElementById('top-scorecard');
      headerSlot.innerHTML = '';
      headerSlot.appendChild(headerCard);

      app.appendChild(applyTeamTotals(teams, rankColors));
      app.appendChild(applyPastEvents(pastEvents, teamsByName));
      app.appendChild(applyUpcoming(data.upcoming || []));
    }).catch(err=>{
      console.error(err);
      showError('Could not load scoreboard data.');
    });

  })();
  </script>
</body>
</html>