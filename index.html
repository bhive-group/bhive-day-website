<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Scoreboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
  <div class="max-w-6xl mx-auto p-4">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Scoreboard</h1>
      <p class="text-sm text-gray-600">Dynamic scoreboard loaded from data.json</p>
    </header>

    <main id="app" aria-live="polite">
      <div id="loading" class="text-center py-12 text-gray-500">Loading…</div>
    </main>
  </div>

  <script>
  (function(){
    const app = document.getElementById('app');
    const loading = document.getElementById('loading');

    function hexToRgb(hex){
      const h = hex.replace('#','');
      const full = h.length===3? h.split('').map(s=>s+s).join(''): h;
      const bigint = parseInt(full,16);
      return [(bigint>>16)&255, (bigint>>8)&255, bigint&255];
    }
    function luminance(r,g,b){
      const a=[r,g,b].map(v=>{
        v/=255;
        return v<=0.03928? v/12.92: Math.pow((v+0.055)/1.055,2.4);
      });
      return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2];
    }
    function contrastRatio(hexA, hexB){
      const a=hexToRgb(hexA);
      const b=hexToRgb(hexB);
      const L1 = luminance(a[0],a[1],a[2]);
      const L2 = luminance(b[0],b[1],b[2]);
      const lighter = Math.max(L1,L2);
      const darker = Math.min(L1,L2);
      return (lighter+0.05)/(darker+0.05);
    }
    function blend(hex, amount){
      const [r,g,b]=hexToRgb(hex);
      const t = amount;
      const br = Math.round(r*(1-t));
      const bg = Math.round(g*(1-t));
      const bb = Math.round(b*(1-t));
      return '#'+[br,bg,bb].map(v=>v.toString(16).padStart(2,'0')).join('');
    }

    function ordinal(pos){
      if(pos%100>=11 && pos%100<=13) return pos+'th';
      const m = pos%10;
      if(m===1) return pos+'st';
      if(m===2) return pos+'nd';
      if(m===3) return pos+'rd';
      return pos+'th';
    }

    function applyTeamTotals(teams, rankColors){
      const section = document.createElement('section');
      section.className = 'mb-8';
      const h = document.createElement('h2');
      h.className = 'text-lg font-semibold mb-3';
      h.textContent = 'Team Totals';
      section.appendChild(h);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';

      teams.forEach(team=>{
        const card = document.createElement('article');
        card.className = 'relative bg-white shadow-sm rounded p-4 overflow-hidden';
        card.style.borderLeft = '4px solid ' + (team.color || '#000');

        const rankColor = rankColors[String(team.rank)] || '#111827';
        let badgeBg = rankColor;
        const whiteContrast = contrastRatio(badgeBg, '#ffffff');
        if(whiteContrast < 4.5){
          badgeBg = blend(badgeBg, 0.35);
        }

        const badge = document.createElement('div');
        badge.className = 'absolute -top-3 -left-3 px-3 py-1 rounded-md text-sm font-bold';
        badge.style.backgroundColor = badgeBg;
        badge.style.color = '#ffffff';
        badge.setAttribute('aria-hidden','true');
        badge.textContent = 'Rank ' + team.rank;
        card.appendChild(badge);

        const name = document.createElement('div');
        name.className = 'text-xl font-semibold';
        name.style.color = team.color || '#111827';
        name.textContent = team.name;
        card.appendChild(name);

        const score = document.createElement('div');
        score.className = 'text-sm text-gray-500 mt-1';
        score.textContent = String(team.total) + ' pts';
        card.appendChild(score);

        const rankNum = document.createElement('div');
        rankNum.className = 'absolute top-3 right-3 text-2xl font-extrabold';
        rankNum.style.color = rankColor;
        rankNum.textContent = team.rank;
        rankNum.setAttribute('aria-label','Team rank');
        card.appendChild(rankNum);

        grid.appendChild(card);
      });

      section.appendChild(grid);
      return section;
    }

    function applyPastEvents(pastEvents, teamsByName){
      const section = document.createElement('section');
      section.className = 'mb-8';
      const h = document.createElement('h2');
      h.className = 'text-lg font-semibold mb-3';
      h.textContent = 'Past Events';
      section.appendChild(h);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

      pastEvents.forEach(ev=>{
        const card = document.createElement('article');
        card.className = 'bg-white shadow-sm rounded p-4';
        const title = document.createElement('h3');
        title.className = 'font-semibold mb-2';
        title.textContent = ev.name;
        card.appendChild(title);

        const list = document.createElement('ol');
        list.className = 'list-decimal list-inside space-y-1';

        (ev.placements || []).sort((a,b)=>a.pos-b.pos).forEach(place=>{
          const li = document.createElement('li');
          li.className = 'flex justify-between';
          const teamSpan = document.createElement('span');
          const team = teamsByName[place.team];
          teamSpan.textContent = place.team;
          teamSpan.style.color = team?.color || '#111827';
          const pts = document.createElement('span');
          pts.className = 'text-sm text-gray-500';
          pts.textContent = place.points + ' pts';
          li.appendChild(teamSpan);
          li.appendChild(pts);
          list.appendChild(li);
        });

        card.appendChild(list);
        grid.appendChild(card);
      });

      section.appendChild(grid);
      return section;
    }

    function applyUpcoming(upcoming){
      const section = document.createElement('section');
      section.className = 'mb-12';
      const h = document.createElement('h2');
      h.className = 'text-lg font-semibold mb-3';
      h.textContent = 'Upcoming Events';
      section.appendChild(h);

      const tableWrap = document.createElement('div');
      tableWrap.className = 'bg-white shadow-sm rounded overflow-auto';

      const table = document.createElement('table');
      table.className = 'min-w-full table-auto';

      const thead = document.createElement('thead');
      thead.className = 'bg-gray-100';
      thead.innerHTML = '<tr><th class="text-left p-3">Event</th><th class="p-3">1st</th><th class="p-3">2nd</th><th class="p-3">3rd</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      (upcoming || []).forEach(ev=>{
        const tr = document.createElement('tr');
        tr.className = 'border-t';
        const nameTd = document.createElement('td');
        nameTd.className = 'p-3';
        nameTd.textContent = ev.name;
        tr.appendChild(nameTd);

        const positions = (ev.positions || []).sort((a,b)=>a.pos-b.pos);
        for(let i=0;i<3;i++){
          const pos = positions[i] || {pos: i+1, points: 0};
          const td = document.createElement('td');
          td.className = 'p-3 text-center';
          const label = ordinal(pos.pos);
          td.textContent = `${label} — ${pos.points} pts`;
          if(i===0) td.classList.add('font-semibold');
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      tableWrap.appendChild(table);
      section.appendChild(tableWrap);
      return section;
    }

    function showError(message){
      app.innerHTML = '';
      const err = document.createElement('div');
      err.className = 'bg-red-50 border border-red-200 text-red-800 p-4 rounded';
      err.textContent = message;
      app.appendChild(err);
    }

    fetch('./data.json', {cache: 'no-store'}).then(r=>{
      if(!r.ok) throw new Error('Failed to load data.json: ' + r.status);
      return r.json();
    }).then(data=>{
      loading?.remove();
      app.innerHTML = '';

      const teamsSource = data.teams || [];
      const pastEvents = data.pastEvents || [];
      const rankColors = data.rankColors || {};

      const totals = {};
      (pastEvents || []).forEach(ev=>{
        (ev.placements || []).forEach(p=>{
          totals[p.team] = (totals[p.team] || 0) + (p.points || 0);
        });
      });

      teamsSource.forEach(t=>{
        if(!(t.name in totals)) totals[t.name] = 0;
      });

      const teams = teamsSource.map(t=>({
        name: t.name,
        color: t.color,
        total: totals[t.name] || 0
      }));

      teams.sort((a,b)=>b.total - a.total);
      teams.forEach((t,i)=> t.rank = i+1);

      const teamsByName = {};
      teams.forEach(t=>teamsByName[t.name] = t);

      app.appendChild(applyTeamTotals(teams, rankColors));
      app.appendChild(applyPastEvents(pastEvents, teamsByName));
      app.appendChild(applyUpcoming(data.upcoming || []));
    }).catch(err=>{
      console.error(err);
      showError('Could not load scoreboard data.');
    });

  })();
  </script>
</body>
</html>